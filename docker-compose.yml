services:
  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: nimbusu-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - nimbusu-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Kafka Cluster (from kafka/docker-compose.yaml)
  kafka-1:
    image: apache/kafka:latest
    container_name: kafka-1
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:9092,EXTERNAL://localhost:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      CLUSTER_ID: abcdefghijklmnopqrstuv
    ports:
      - "9094:9094"
    networks:
      - nimbusu-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 5

  kafka-2:
    image: apache/kafka:latest
    container_name: kafka-2
    environment:
      KAFKA_NODE_ID: 2
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9095
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-2:9092,EXTERNAL://localhost:9095
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      CLUSTER_ID: abcdefghijklmnopqrstuv
    ports:
      - "9095:9095"
    networks:
      - nimbusu-network

  kafka-3:
    image: apache/kafka:latest
    container_name: kafka-3
    environment:
      KAFKA_NODE_ID: 3
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9096
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-3:9092,EXTERNAL://localhost:9096
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      CLUSTER_ID: abcdefghijklmnopqrstuv
    ports:
      - "9096:9096"
    networks:
      - nimbusu-network

  # Kafka UI
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=nimbusu-cluster
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - DYNAMIC_CONFIG_ENABLED=true
    networks:
      - nimbusu-network

  # Content Service
  content-service:
    build:
      context: .
      dockerfile: services/content-service/Dockerfile
    container_name: content-service
    depends_on:
      kafka-1:
        condition: service_healthy
    ports:
      - "8001:8001"
    environment:
      - SERVICE_NAME=content-service
      - PORT=8001
      - ENVIRONMENT=development
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=1475
      - DB_NAME=nimbusu
      - DB_SSL_MODE=disable
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - KAFKA_GROUP_ID=content-service-group
      - JWT_SECRET=your-secret-key-change-in-production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - nimbusu-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Media Service
  media-service:
    build:
      context: .
      dockerfile: services/media-service/Dockerfile
    container_name: media-service
    depends_on:
      kafka-1:
        condition: service_healthy
    ports:
      - "8002:8002"
    environment:
      - SERVICE_NAME=media-service
      - PORT=8002
      - ENVIRONMENT=development
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=1475
      - DB_NAME=nimbusu
      - DB_SSL_MODE=disable
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - KAFKA_GROUP_ID=media-service-group
      - JWT_SECRET=your-secret-key-change-in-production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - media_uploads:/root/uploads
    networks:
      - nimbusu-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Workflow Service
  workflow-service:
    build:
      context: .
      dockerfile: services/workflow-service/Dockerfile
    container_name: workflow-service
    depends_on:
      kafka-1:
        condition: service_healthy
    ports:
      - "8003:8003"
    environment:
      - SERVICE_NAME=workflow-service
      - PORT=8003
      - ENVIRONMENT=development
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=1475
      - DB_NAME=nimbusu
      - DB_SSL_MODE=disable
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - KAFKA_GROUP_ID=workflow-service-group
      - JWT_SECRET=your-secret-key-change-in-production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - nimbusu-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  nimbusu-network:
    driver: bridge

volumes:
  redis_data:
    driver: local
  media_uploads:
    driver: local
